<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neon Candy Legends</title>
<style>
:root{--bg1:#080713;--bg2:#151133;--tile:clamp(36px,8.8vw,60px);--gap:clamp(4px,1vw,8px);--txt:#eef5ff;--p:rgba(255,255,255,.09);--b:rgba(255,255,255,.2);--c0:#ff4ec9;--c1:#33d9ff;--c2:#35f49d;--c3:#ffde59;--c4:#ff8c42;--c5:#a687ff}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;color:var(--txt);font-family:"Trebuchet MS","Segoe UI",sans-serif;background:radial-gradient(1000px 500px at 10% -10%,rgba(0,255,200,.16),transparent),radial-gradient(800px 600px at 90% 0%,rgba(255,70,220,.14),transparent),linear-gradient(155deg,var(--bg1),var(--bg2));display:grid;place-items:center;overflow-x:hidden}
.bg{position:fixed;inset:0;pointer-events:none;z-index:-1;overflow:hidden}.dust{position:absolute;width:5px;height:5px;border-radius:50%;background:rgba(180,255,243,.35);animation:drift linear infinite}@keyframes drift{from{transform:translateY(0);opacity:.75}to{transform:translateY(-120vh);opacity:0}}
.app{width:min(980px,96vw);padding:12px;border-radius:20px;background:linear-gradient(165deg,rgba(255,255,255,.14),rgba(255,255,255,.05));border:1px solid var(--b);box-shadow:0 16px 36px rgba(0,0,0,.42);backdrop-filter:blur(8px);opacity:1;transform:translateY(0);transition:opacity .22s ease,transform .22s ease}.app.hidden-state{opacity:0;transform:translateY(8px);pointer-events:none}
.top{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;margin-bottom:8px}.stat{background:var(--p);border:1px solid var(--b);border-radius:12px;text-align:center;padding:8px 6px;box-shadow:0 0 18px rgba(120,255,230,.32)}.k{font-size:11px;letter-spacing:.07em;opacity:.85;text-transform:uppercase}.v{font-size:clamp(15px,2.5vw,21px);font-weight:700;margin-top:2px}
.actions{margin-bottom:8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}.icon-btn{border:1px solid var(--b);background:rgba(255,255,255,.12);border-radius:999px;color:var(--txt);font:inherit;font-weight:700;padding:8px 14px;cursor:pointer;box-shadow:0 0 14px rgba(95,226,255,.26)}
.progress-wrap{height:12px;border-radius:999px;background:rgba(7,20,45,.6);border:1px solid rgba(255,255,255,.2);overflow:hidden;margin-bottom:8px}.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#69e8ff,#72ffd5,#ffe58b);box-shadow:0 0 14px rgba(114,255,213,.62);transition:width .22s ease}.inline-info{margin:0 0 8px;text-align:center;opacity:.9;font-size:14px}
.boosters,.shop{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:8px}.mini-btn{border:1px solid var(--b);background:rgba(255,255,255,.12);border-radius:10px;color:var(--txt);font:inherit;padding:7px 10px;cursor:pointer;display:flex;align-items:center;gap:6px}.mini-btn.active{outline:2px solid #84ffe0;box-shadow:0 0 16px rgba(132,255,224,.6)}.mini-btn:disabled{opacity:.55;cursor:not-allowed}.mini-icon{width:16px;height:16px;object-fit:contain;filter:drop-shadow(0 1px 1px rgba(0,0,0,.35))}
.wrap{position:relative;width:fit-content;margin:0 auto;padding:10px;border-radius:18px;background:rgba(2,8,24,.55);border:1px solid rgba(255,255,255,.15);box-shadow:inset 0 0 24px rgba(20,130,255,.18);touch-action:none}
#board{display:grid;gap:var(--gap);user-select:none;-webkit-user-select:none}.cell{width:var(--tile);height:var(--tile);border-radius:13px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);position:relative;overflow:hidden}.cell.blocked{background:linear-gradient(145deg,#22253b,#121424);border-color:rgba(255,255,255,.12)}.cell.blocked::before{content:"";position:absolute;inset:10px;border:2px dashed rgba(255,255,255,.26);border-radius:10px}
.cell.hint::after{content:"";position:absolute;inset:3px;border:2px solid #fff39b;border-radius:11px;box-shadow:0 0 16px rgba(255,243,155,.9);animation:hintPulse .8s ease-in-out infinite alternate}@keyframes hintPulse{from{transform:scale(.94);opacity:.8}to{transform:scale(1.03);opacity:1}}
.candy{position:absolute;inset:4px;border-radius:11px;box-shadow:inset 0 1px 5px rgba(255,255,255,.5),0 3px 10px rgba(0,0,0,.35);transition:transform .3s cubic-bezier(.22,1,.36,1),filter .16s ease;animation:spawn .24s ease;will-change:transform}@keyframes spawn{from{transform:scale(.66);opacity:.45}to{transform:scale(1);opacity:1}}
.c0{background:radial-gradient(circle at 30% 28%,#ffd2f2,var(--c0))}.c1{background:radial-gradient(circle at 30% 28%,#d9f6ff,var(--c1))}.c2{background:radial-gradient(circle at 30% 28%,#ceffe4,var(--c2))}.c3{background:radial-gradient(circle at 30% 28%,#fff8bf,var(--c3))}.c4{background:radial-gradient(circle at 30% 28%,#ffe0c6,var(--c4))}.c5{background:radial-gradient(circle at 30% 28%,#eadfff,var(--c5))}
.selected{transform:scale(1.1);filter:brightness(1.2);box-shadow:0 0 20px rgba(255,255,255,.9)}.matched{animation:glow .27s ease}@keyframes glow{50%{filter:brightness(1.45);box-shadow:0 0 20px rgba(255,255,255,.95)}}
.lineH::before,.lineV::before{content:"";position:absolute;inset:8px;border-radius:8px;background:repeating-linear-gradient(45deg,rgba(255,255,255,.95) 0 5px,rgba(255,255,255,.2) 5px 10px);mix-blend-mode:screen}.lineV::before{background:repeating-linear-gradient(90deg,rgba(255,255,255,.95) 0 5px,rgba(255,255,255,.2) 5px 10px)}
.bomb::before{content:"B";position:absolute;inset:0;display:grid;place-items:center;font-size:clamp(18px,4vw,24px);text-shadow:0 0 12px rgba(255,255,255,.9)}.color{background:conic-gradient(from 0deg,#ff59cb,#6ef9ff,#ffe36f,#71ffb3,#b7a2ff,#ff59cb);box-shadow:0 0 16px rgba(255,255,255,.9)}.color::before{content:"*";position:absolute;inset:0;display:grid;place-items:center;font-size:clamp(20px,4.4vw,27px);color:#f8ffff;text-shadow:0 0 10px rgba(255,255,255,.9)}
.glyph-img{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:58%;height:58%;object-fit:contain;filter:drop-shadow(0 1px 2px rgba(0,0,0,.35));pointer-events:none}
.falling{animation:drop .28s cubic-bezier(.22,1,.36,1)}@keyframes drop{from{transform:translateY(calc(-1*var(--drop,1)*(var(--tile)+var(--gap))))}to{transform:translateY(0)}}
.fx{position:absolute;inset:10px;pointer-events:none;overflow:hidden}.spark{position:absolute;width:6px;height:6px;border-radius:50%;background:var(--spark,#fff);opacity:0;animation:spark .55s ease forwards}@keyframes spark{0%{transform:translate(0,0) scale(.8);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(.1);opacity:0}}
.combo{position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);font-size:clamp(24px,6vw,42px);font-weight:800;text-shadow:0 0 18px rgba(255,255,255,.9);animation:combo .9s ease forwards;pointer-events:none;z-index:9}@keyframes combo{20%{opacity:1;transform:translate(-50%,-50%) scale(1.08)}100%{opacity:0;transform:translate(-50%,-110%) scale(1)}}
.ov{position:fixed;inset:0;display:grid;place-items:center;background:rgba(3,6,16,.78);backdrop-filter:blur(5px);z-index:30;padding:14px;opacity:0;visibility:hidden;transition:opacity .26s ease,visibility .26s ease}.ov.show{opacity:1;visibility:visible}
.panel{width:min(560px,95vw);border-radius:18px;padding:22px 18px;text-align:center;background:linear-gradient(170deg,rgba(255,255,255,.18),rgba(255,255,255,.07));border:1px solid rgba(255,255,255,.25);box-shadow:0 18px 30px rgba(0,0,0,.45);transform:translateY(10px);transition:transform .26s ease}.ov.show .panel{transform:translateY(0)}
.title{margin:0 0 10px;font-size:clamp(28px,8vw,46px);letter-spacing:.03em;background:linear-gradient(90deg,#72ffd5,#69e8ff,#ff89d2);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 14px rgba(120,255,240,.42)}
.btn{border:0;border-radius:999px;padding:11px 22px;margin:8px 5px 0;font:inherit;font-weight:700;cursor:pointer;color:#04152a;background:linear-gradient(90deg,#8affde,#66eeff);box-shadow:0 8px 20px rgba(102,238,255,.35)}.btn.alt{background:linear-gradient(90deg,#ffd884,#ff9b72);box-shadow:0 8px 20px rgba(255,155,114,.32);color:#2e1300}
.muted{opacity:.88;font-size:14px}.start-controls{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:8px}.select{border:1px solid var(--b);background:rgba(255,255,255,.13);border-radius:999px;color:var(--txt);font:inherit;font-weight:700;padding:8px 14px}
.help-text{text-align:left;line-height:1.5;font-size:14px;opacity:.95}.help-text p{margin:8px 0}.settings-row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0;text-align:left}.settings-row label{font-weight:700}.range{width:180px}.settings-value{min-width:56px;text-align:right;font-weight:700}
.loader-ring{width:62px;height:62px;border-radius:50%;border:4px solid rgba(255,255,255,.25);border-top-color:#8affde;margin:8px auto 14px;animation:spin .85s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:760px){.app{padding:10px}.top{grid-template-columns:repeat(3,minmax(0,1fr))}}
</style>
</head>
<body>
<div class="bg" id="bg"></div>
<main class="app hidden-state" id="game" hidden>
<section class="top">
<div class="stat"><div class="k">Score</div><div class="v" id="score">0</div></div>
<div class="stat"><div class="k">Moves</div><div class="v" id="moves">0</div></div>
<div class="stat"><div class="k">Level</div><div class="v" id="level">1</div></div>
<div class="stat"><div class="k">Target</div><div class="v" id="target">0</div></div>
<div class="stat"><div class="k">Coins</div><div class="v" id="coins">0</div></div>
<div class="stat"><div class="k">High</div><div class="v" id="high">0</div></div>
</section>
<section class="actions"><button class="icon-btn" id="pauseBtn">Pause</button><button class="icon-btn" id="restartLevelBtn">Restart</button><button class="icon-btn" id="helpGameBtn">How To Play</button><button class="icon-btn" id="settingsGameBtn">Settings</button></section>
<div class="progress-wrap"><div class="progress-bar" id="progressBar"></div></div>
<p class="inline-info" id="levelBestInfo">Level Best: 0</p>
<section class="boosters"><button class="mini-btn" data-booster="lollipop" id="boosterLollipop">Lollipop x0</button><button class="mini-btn" data-booster="hammer" id="boosterHammer">Hammer x0</button><button class="mini-btn" data-booster="bomb" id="boosterBomb">Bomb x0</button><button class="mini-btn" data-booster="shuffle" id="boosterShuffle">Shuffle x0</button></section>
<section class="shop"><button class="mini-btn" id="buyLollipop">Buy Lollipop (120)</button><button class="mini-btn" id="buyHammer">Buy Hammer (150)</button><button class="mini-btn" id="buyBomb">Buy Bomb (240)</button><button class="mini-btn" id="buyShuffle">Buy Shuffle (200)</button></section>
<section class="wrap" id="wrap"><div id="board"></div><div class="fx" id="fx"></div></section>
</main>
<section class="ov show" id="loading"><div class="panel"><h1 class="title">Neon Candy Legends</h1><div class="loader-ring"></div><p>Loading offline neon world...</p></div></section>
<section class="ov" id="home"><div class="panel"><h1 class="title">Neon Candy Legends</h1><p>Choose your style, then crush matches with smooth neon combos.</p><p class="muted" id="homeInfo"></p><div class="start-controls"><label for="levelSelect" class="muted">Level</label><select class="select" id="levelSelect"></select><label for="themeSelect" class="muted">Theme</label><select class="select" id="themeSelect"><option value="candy">Candy</option><option value="fruits">Fruits</option><option value="mixed">Mixed</option></select></div><button class="btn" id="startBtn">Start Game</button><button class="btn alt" id="soundBtn">Sound: On</button><button class="btn alt" id="helpHomeBtn">How To Play</button><button class="btn alt" id="settingsHomeBtn">Settings</button><p class="muted">No internet required. Shortcuts: Space pause, R restart, M sound, H help, S settings</p></div></section>
<section class="ov" id="pause"><div class="panel"><h2>Paused</h2><p>Game is paused.</p><button class="btn" id="resumeBtn">Resume</button><button class="btn alt" id="pauseRestartBtn">Restart Level</button></div></section>
<section class="ov" id="win"><div class="panel"><h2>Level Complete</h2><p id="winTxt"></p><button class="btn" id="nextBtn">Next Level</button><button class="btn alt" id="retryWinBtn">Retry Level</button></div></section>
<section class="ov" id="lose"><div class="panel"><h2>Game Over</h2><p id="loseTxt"></p><button class="btn" id="retryBtn">Retry Level</button><button class="btn alt" id="homeBtn">Home</button></div></section>
<section class="ov" id="help"><div class="panel"><h2>How To Play</h2><div class="help-text"><p>Swap adjacent pieces to match 3+.</p><p>Boosters: Lollipop/Hammer remove one tile, Bomb clears 3x3, Shuffle remixes board.</p><p>If you stay idle for 10s, a glowing hint appears. Use that move to trigger a bonus blast and extra points.</p><p>Earn coins from matches and especially level wins. Use coins to buy boosters.</p><p>Higher levels reduce moves and increase required score/colors/blocked cells.</p></div><button class="btn" id="closeHelpBtn">Close</button></div></section>
<section class="ov" id="settings"><div class="panel"><h2>Settings</h2><div class="settings-row"><label for="speedRange">Animation Speed</label><input class="range" type="range" min="50" max="150" step="10" id="speedRange"><span class="settings-value" id="speedVal">100%</span></div><div class="settings-row"><label for="volumeRange">SFX/BGM Volume</label><input class="range" type="range" min="0" max="100" step="5" id="volumeRange"><span class="settings-value" id="volumeVal">100%</span></div><button class="btn" id="closeSettingsBtn">Close</button></div></section>
<script>
const SP={H:"lineH",V:"lineV",B:"bomb",C:"color"},KEY="neon-candy-legends-save-v4";
const el={game:q("game"),wrap:q("wrap"),board:q("board"),fx:q("fx"),score:q("score"),moves:q("moves"),level:q("level"),target:q("target"),coins:q("coins"),high:q("high"),progressBar:q("progressBar"),levelBestInfo:q("levelBestInfo"),levelSelect:q("levelSelect"),themeSelect:q("themeSelect"),speedRange:q("speedRange"),speedVal:q("speedVal"),volumeRange:q("volumeRange"),volumeVal:q("volumeVal"),bg:q("bg"),loading:q("loading"),home:q("home"),pause:q("pause"),win:q("win"),lose:q("lose"),help:q("help"),settings:q("settings"),winTxt:q("winTxt"),loseTxt:q("loseTxt"),homeInfo:q("homeInfo"),startBtn:q("startBtn"),soundBtn:q("soundBtn"),helpHomeBtn:q("helpHomeBtn"),helpGameBtn:q("helpGameBtn"),closeHelpBtn:q("closeHelpBtn"),settingsHomeBtn:q("settingsHomeBtn"),settingsGameBtn:q("settingsGameBtn"),closeSettingsBtn:q("closeSettingsBtn"),pauseBtn:q("pauseBtn"),restartLevelBtn:q("restartLevelBtn"),resumeBtn:q("resumeBtn"),pauseRestartBtn:q("pauseRestartBtn"),nextBtn:q("nextBtn"),retryBtn:q("retryBtn"),retryWinBtn:q("retryWinBtn"),homeBtn:q("homeBtn"),boosterLollipop:q("boosterLollipop"),boosterHammer:q("boosterHammer"),boosterBomb:q("boosterBomb"),boosterShuffle:q("boosterShuffle"),buyLollipop:q("buyLollipop"),buyHammer:q("buyHammer"),buyBomb:q("buyBomb"),buyShuffle:q("buyShuffle")};
let s={rows:8,cols:8,board:[],selected:null,busy:false,paused:false,score:0,moves:0,level:1,target:0,coins:0,chain:0,last:new Set(),high:0,unlocked:1,sound:true,ptr:null,startLevel:1,bestByLevel:{},overlayReturn:null,animScale:1,volume:1,theme:"candy",activeBooster:null,boosters:{lollipop:1,hammer:1,bomb:1,shuffle:1},hintPair:null,idleTimer:null};
let ctx=null,bgmTimer=null,bgmStep=0;
function q(id){return document.getElementById(id)}
const key=(r,c)=>`${r},${c}`,inb=(r,c)=>r>=0&&c>=0&&r<s.rows&&c<s.cols,adj=(a,b)=>Math.abs(a.r-b.r)+Math.abs(a.c-b.c)===1,empty=()=>({candy:null,sp:null,blocked:false}),rnd=(n)=>Math.floor(Math.random()*n),sl=(ms)=>new Promise(r=>setTimeout(r,ms)),wait=(ms)=>sl(Math.max(20,Math.floor(ms*s.animScale)));
function iconSvg(kind,b1,b2){const base=`<defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="${b1}"/><stop offset="1" stop-color="${b2}"/></linearGradient></defs><rect x="7" y="7" width="50" height="50" rx="14" fill="url(#g)"/><circle cx="24" cy="22" r="7" fill="#fff" opacity=".2"/>`;const map={candy:`<rect x="17" y="27" width="30" height="12" rx="6" fill="#fff" opacity=".9"/><polygon points="17,33 10,28 10,38" fill="#fff" opacity=".8"/><polygon points="47,33 54,28 54,38" fill="#fff" opacity=".8"/>`,lollipop:`<circle cx="32" cy="29" r="12" fill=\"#fff\" opacity=\".9\"/><line x1=\"32\" y1=\"41\" x2=\"32\" y2=\"54\" stroke=\"#fff\" stroke-width=\"4\" stroke-linecap=\"round\"/>`,cookie:`<circle cx=\"32\" cy=\"33\" r=\"13\" fill=\"#f7e3b1\"/><circle cx=\"27\" cy=\"30\" r=\"2\" fill=\"#8e5a36\"/><circle cx=\"36\" cy=\"29\" r=\"2\" fill=\"#8e5a36\"/><circle cx=\"33\" cy=\"37\" r=\"2\" fill=\"#8e5a36\"/>`,choco:`<rect x=\"19\" y=\"21\" width=\"26\" height=\"24\" rx=\"4\" fill=\"#6a4026\"/><line x1=\"19\" y1=\"29\" x2=\"45\" y2=\"29\" stroke=\"#a47251\"/><line x1=\"19\" y1=\"37\" x2=\"45\" y2=\"37\" stroke=\"#a47251\"/><line x1=\"27\" y1=\"21\" x2=\"27\" y2=\"45\" stroke=\"#a47251\"/><line x1=\"36\" y1=\"21\" x2=\"36\" y2=\"45\" stroke=\"#a47251\"/>`,donut:`<circle cx=\"32\" cy=\"33\" r=\"14\" fill=\"#fff2ce\"/><circle cx=\"32\" cy=\"33\" r=\"6\" fill=\"url(#g)\"/>`,gem:`<polygon points=\"32,18 45,30 32,46 19,30\" fill=\"#fff\" opacity=\".9\"/>`,straw:`<path d=\"M20 37c0-8 6-14 12-14s12 6 12 14c0 6-5 11-12 11s-12-5-12-11z\" fill=\"#ff4f6d\"/><ellipse cx=\"32\" cy=\"21\" rx=\"8\" ry=\"4\" fill=\"#6aff8b\"/>`,melon:`<path d=\"M18 38a14 14 0 0 1 28 0z\" fill=\"#ff637d\"/><path d=\"M18 38a14 14 0 0 0 28 0\" fill=\"none\" stroke=\"#6aff8b\" stroke-width=\"4\"/>`,lemon:`<ellipse cx=\"32\" cy=\"33\" rx=\"13\" ry=\"10\" fill=\"#ffe56f\"/><ellipse cx=\"32\" cy=\"33\" rx=\"8\" ry=\"5\" fill=\"#fff\" opacity=\".25\"/>`,cherry:`<circle cx=\"26\" cy=\"38\" r=\"7\" fill=\"#ff4f6d\"/><circle cx=\"38\" cy=\"38\" r=\"7\" fill=\"#ff4f6d\"/><path d=\"M26 31c3-8 9-10 12-13\" stroke=\"#6aff8b\" stroke-width=\"2\" fill=\"none\"/>`,grape:`<circle cx=\"26\" cy=\"34\" r=\"6\" fill=\"#b58cff\"/><circle cx=\"34\" cy=\"34\" r=\"6\" fill=\"#b58cff\"/><circle cx=\"30\" cy=\"41\" r=\"6\" fill=\"#b58cff\"/><ellipse cx=\"34\" cy=\"23\" rx=\"6\" ry=\"4\" fill=\"#6aff8b\"/>`,pine:`<ellipse cx=\"32\" cy=\"35\" rx=\"10\" ry=\"12\" fill=\"#ffd46f\"/><path d=\"M32 17l-4 6h8zM26 21l-4 6h8zM38 21l-4 6h8z\" fill=\"#6aff8b\"/>`};const shape=map[kind]||map.gem;const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">${base}${shape}</svg>`;return`data:image/svg+xml;utf8,${encodeURIComponent(svg)}`}
function toolIcon(kind){const map={lollipop:`<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 64 64\"><circle cx=\"32\" cy=\"25\" r=\"14\" fill=\"#ff7bc5\"/><circle cx=\"32\" cy=\"25\" r=\"7\" fill=\"#fff\" opacity=\".5\"/><rect x=\"29\" y=\"37\" width=\"6\" height=\"20\" rx=\"3\" fill=\"#fff\"/></svg>`,hammer:`<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 64 64\"><rect x=\"13\" y=\"12\" width=\"30\" height=\"14\" rx=\"4\" fill=\"#9fb3d1\"/><rect x=\"30\" y=\"24\" width=\"8\" height=\"30\" rx=\"4\" fill=\"#b37d4f\"/></svg>`,bomb:`<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 64 64\"><circle cx=\"30\" cy=\"36\" r=\"16\" fill=\"#2a2a2a\"/><rect x=\"27\" y=\"16\" width=\"8\" height=\"8\" rx=\"2\" fill=\"#7a7a7a\"/><path d=\"M34 16c8-6 12-2 14 2\" stroke=\"#ffcc54\" stroke-width=\"3\" fill=\"none\"/></svg>`,shuffle:`<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 64 64\"><path d=\"M12 18h10l9 10h21\" stroke=\"#7df7ff\" stroke-width=\"6\" fill=\"none\" stroke-linecap=\"round\"/><path d=\"M52 28l-7-6m7 6l-7 6\" stroke=\"#7df7ff\" stroke-width=\"4\" fill=\"none\" stroke-linecap=\"round\"/><path d=\"M12 46h10l8-9\" stroke=\"#ffb86f\" stroke-width=\"6\" fill=\"none\" stroke-linecap=\"round\"/><path d=\"M52 36l-7 6m7-6l-7-6\" stroke=\"#ffb86f\" stroke-width=\"4\" fill=\"none\" stroke-linecap=\"round\"/></svg>`};return`data:image/svg+xml;utf8,${encodeURIComponent(map[kind])}`}
const ICONS={candy:[iconSvg("candy","#ff76d7","#ff3db6"),iconSvg("lollipop","#ffab58","#ff7f2f"),iconSvg("cookie","#9b8bff","#7c62ff"),iconSvg("choco","#8b5a37","#5f3b23"),iconSvg("gem","#52d7ff","#27aef0"),iconSvg("donut","#7df7b0","#29d98a")],fruits:[iconSvg("straw","#ff5b8d","#de2f66"),iconSvg("melon","#ff7f65","#db4e35"),iconSvg("lemon","#ffe26e","#f8c61f"),iconSvg("cherry","#ff6b75","#e53846"),iconSvg("grape","#b98cff","#8d5df1"),iconSvg("pine","#ffd15e","#f6aa2a")],mixed:[]};ICONS.mixed=[ICONS.candy[0],ICONS.fruits[0],ICONS.candy[2],ICONS.fruits[2],ICONS.candy[4],ICONS.fruits[4]];
function showOverlay(target){[el.loading,el.home,el.pause,el.win,el.lose,el.help,el.settings].forEach(node=>node.classList.toggle("show",node===target));updateBgmState()}
function load(){try{const x=JSON.parse(localStorage.getItem(KEY)||"null");if(!x)return;if(Number.isFinite(x.high))s.high=x.high;if(Number.isFinite(x.unlocked))s.unlocked=Math.max(1,Math.floor(x.unlocked));if(Number.isFinite(x.coins))s.coins=Math.max(0,Math.floor(x.coins));if(typeof x.sound==="boolean")s.sound=x.sound;if(x.bestByLevel&&typeof x.bestByLevel==="object")s.bestByLevel=x.bestByLevel;if(x.boosters&&typeof x.boosters==="object")s.boosters={...s.boosters,...x.boosters};if(Number.isFinite(x.animScale))s.animScale=Math.min(1.5,Math.max(.5,x.animScale));if(Number.isFinite(x.volume))s.volume=Math.min(1,Math.max(0,x.volume));if(typeof x.theme==="string"&&ICONS[x.theme])s.theme=x.theme}catch(_){}}
function save(){localStorage.setItem(KEY,JSON.stringify({high:s.high,unlocked:s.unlocked,coins:s.coins,sound:s.sound,bestByLevel:s.bestByLevel,boosters:s.boosters,animScale:s.animScale,volume:s.volume,theme:s.theme}))}
function cfg(l){return{moves:Math.max(7,23-Math.floor(l*0.9)),target:1500+Math.floor(l*760+Math.pow(l,1.7)*100),colors:Math.min(6,4+Math.floor((l-1)/2)),blocked:Math.min(10,Math.floor((l-1)/3))}}
const levelBest=(l)=>Number.isFinite(Number(s.bestByLevel[l]))?Number(s.bestByLevel[l]):0;
function syncLevelSelect(){el.levelSelect.innerHTML="";for(let i=1;i<=s.unlocked;i++){const op=document.createElement("option");op.value=String(i);op.textContent=`Level ${i}`;el.levelSelect.appendChild(op)}if(s.startLevel>s.unlocked)s.startLevel=s.unlocked;el.levelSelect.value=String(s.startLevel)}
function syncSettingsUi(){el.speedRange.value=String(Math.round(s.animScale*100));el.speedVal.textContent=`${Math.round(s.animScale*100)}%`;el.volumeRange.value=String(Math.round(s.volume*100));el.volumeVal.textContent=`${Math.round(s.volume*100)}%`;el.themeSelect.value=s.theme}
function updateBoosterHud(){el.boosterLollipop.innerHTML=`<img class="mini-icon" src="${toolIcon("lollipop")}" alt=""> Lollipop x${s.boosters.lollipop}`;el.boosterHammer.innerHTML=`<img class="mini-icon" src="${toolIcon("hammer")}" alt=""> Hammer x${s.boosters.hammer}`;el.boosterBomb.innerHTML=`<img class="mini-icon" src="${toolIcon("bomb")}" alt=""> Bomb x${s.boosters.bomb}`;el.boosterShuffle.innerHTML=`<img class="mini-icon" src="${toolIcon("shuffle")}" alt=""> Shuffle x${s.boosters.shuffle}`;el.buyLollipop.innerHTML=`<img class="mini-icon" src="${toolIcon("lollipop")}" alt=""> Buy (120)`;el.buyHammer.innerHTML=`<img class="mini-icon" src="${toolIcon("hammer")}" alt=""> Buy (150)`;el.buyBomb.innerHTML=`<img class="mini-icon" src="${toolIcon("bomb")}" alt=""> Buy (240)`;el.buyShuffle.innerHTML=`<img class="mini-icon" src="${toolIcon("shuffle")}" alt=""> Buy (200)`;[el.boosterLollipop,el.boosterHammer,el.boosterBomb,el.boosterShuffle].forEach(btn=>btn.classList.toggle("active",s.activeBooster===btn.dataset.booster));el.buyLollipop.disabled=s.coins<120;el.buyHammer.disabled=s.coins<150;el.buyBomb.disabled=s.coins<240;el.buyShuffle.disabled=s.coins<200}
function hud(){el.score.textContent=s.score;el.moves.textContent=s.moves;el.level.textContent=s.level;el.target.textContent=s.target;el.coins.textContent=s.coins;el.high.textContent=s.high;const pct=s.target>0?Math.min(100,Math.floor((s.score/s.target)*100)):0;el.progressBar.style.width=`${pct}%`;el.levelBestInfo.textContent=`Level Best: ${levelBest(s.level)}`;el.soundBtn.textContent=`Sound: ${s.sound?"On":"Off"}`;el.homeInfo.textContent=`High score: ${s.high} | Coins: ${s.coins} | Highest unlocked: ${s.unlocked} | Selected Best: ${levelBest(s.startLevel)}`;el.pauseBtn.textContent=s.paused?"Resume":"Pause";updateBoosterHud()}
function mkBoard(){const c=cfg(s.level);s.moves=c.moves;s.target=c.target;s.chain=0;s.selected=null;s.board=Array.from({length:s.rows},()=>Array.from({length:s.cols},empty));let blockedLeft=c.blocked;while(blockedLeft>0){const r=rnd(s.rows),col=rnd(s.cols);if(!s.board[r][col].blocked){s.board[r][col].blocked=true;blockedLeft--}}do{for(let r=0;r<s.rows;r++)for(let col=0;col<s.cols;col++){if(s.board[r][col].blocked){s.board[r][col].candy=null;s.board[r][col].sp=null}else s.board[r][col]={candy:rnd(c.colors),sp:null,blocked:false}}}while(matches().length||!hasMove());render();hud()}
function iconFor(color){const set=ICONS[s.theme]||ICONS.candy;return set[color%set.length]}
function render(fall=null){el.board.style.gridTemplateColumns=`repeat(${s.cols}, var(--tile))`;el.board.innerHTML="";const sk=s.selected?key(s.selected.r,s.selected.c):null;const hintKeys=s.hintPair?new Set([key(s.hintPair.a.r,s.hintPair.a.c),key(s.hintPair.b.r,s.hintPair.b.c)]):new Set();for(let r=0;r<s.rows;r++)for(let c=0;c<s.cols;c++){const cell=s.board[r][c],h=document.createElement("div");h.className="cell";h.dataset.r=String(r);h.dataset.c=String(c);if(cell.blocked)h.classList.add("blocked");if(hintKeys.has(key(r,c)))h.classList.add("hint");if(!cell.blocked&&(cell.candy!==null||cell.sp===SP.C)){const d=document.createElement("div"),cls=["candy"];if(cell.candy!==null)cls.push(`c${cell.candy}`);if(cell.sp===SP.H)cls.push("lineH");if(cell.sp===SP.V)cls.push("lineV");if(cell.sp===SP.B)cls.push("bomb");if(cell.sp===SP.C)cls.push("color");if(sk===key(r,c))cls.push("selected");if(s.last.has(key(r,c)))cls.push("matched");if(fall&&fall[key(r,c)]){cls.push("falling");d.style.setProperty("--drop",String(fall[key(r,c)]))}d.className=cls.join(" ");if(cell.candy!==null&&cell.sp!==SP.C){const img=document.createElement("img");img.className="glyph-img";img.src=iconFor(cell.candy);img.alt="";img.loading="lazy";img.decoding="async";d.appendChild(img)}h.appendChild(d)}el.board.appendChild(h)}setTimeout(()=>s.last.clear(),10)}
function tsize(){return parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--tile"))||50}
function gsize(){return parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--gap"))||6}
function pop(txt){const d=document.createElement("div");d.className="combo";d.textContent=txt;el.fx.appendChild(d);setTimeout(()=>d.remove(),900)}
function burst(r,c,color,n=9){const t=tsize(),g=gsize(),x=c*(t+g)+t*.5,y=r*(t+g)+t*.5;for(let i=0;i<n;i++){const p=document.createElement("span");p.className="spark";p.style.left=`${x}px`;p.style.top=`${y}px`;p.style.setProperty("--spark",color||"#fff");const a=Math.random()*Math.PI*2,d=14+Math.random()*32;p.style.setProperty("--dx",`${Math.cos(a)*d}px`);p.style.setProperty("--dy",`${Math.sin(a)*d}px`);el.fx.appendChild(p);setTimeout(()=>p.remove(),620)}}
function add(base,chain=1){const gain=Math.floor(base*(1+(chain-1)*.5));s.score+=gain;if(s.score>s.high)s.high=s.score;if(s.score>levelBest(s.level))s.bestByLevel[s.level]=s.score;const coinGain=Math.max(1,Math.floor(gain/300));s.coins+=coinGain;hud();save()}
function matches(){const out=[];for(let r=0;r<s.rows;r++){let c=0;while(c<s.cols){const x=s.board[r][c];if(x.blocked||x.candy===null||x.sp===SP.C){c++;continue}let e=c+1;while(e<s.cols&&!s.board[r][e].blocked&&s.board[r][e].candy===x.candy&&s.board[r][e].sp!==SP.C)e++;if(e-c>=3){const cells=[];for(let cc=c;cc<e;cc++)cells.push({r,c:cc});out.push({cells,o:"h",color:x.candy})}c=e}}for(let c=0;c<s.cols;c++){let r=0;while(r<s.rows){const x=s.board[r][c];if(x.blocked||x.candy===null||x.sp===SP.C){r++;continue}let e=r+1;while(e<s.rows&&!s.board[e][c].blocked&&s.board[e][c].candy===x.candy&&s.board[e][c].sp!==SP.C)e++;if(e-r>=3){const cells=[];for(let rr=r;rr<e;rr++)cells.push({r:rr,c});out.push({cells,o:"v",color:x.candy})}r=e}}return out}
function specials(ms){const p=new Map(),u=new Map();for(const m of ms)for(const a of m.cells){const k=key(a.r,a.c);u.set(k,(u.get(k)||0)+1)}for(const m of ms){if(m.cells.length>=5){const a=m.cells[2];p.set(key(a.r,a.c),{sp:SP.C,color:null});continue}const cross=m.cells.find(a=>(u.get(key(a.r,a.c))||0)>=2);if(cross){p.set(key(cross.r,cross.c),{sp:SP.B,color:m.color});continue}if(m.cells.length===4){const a=m.cells[1];p.set(key(a.r,a.c),{sp:m.o==="h"?SP.H:SP.V,color:m.color})}}return p}
function ext(cell,r,c,set){if(cell.sp===SP.H)for(let i=0;i<s.cols;i++)if(!s.board[r][i].blocked)set.add(key(r,i));else if(cell.sp===SP.V)for(let i=0;i<s.rows;i++)if(!s.board[i][c].blocked)set.add(key(i,c));else if(cell.sp===SP.B)for(let rr=r-1;rr<=r+1;rr++)for(let cc=c-1;cc<=c+1;cc++)if(inb(rr,cc)&&!s.board[rr][cc].blocked)set.add(key(rr,cc))}
function clrColor(color,set){for(let r=0;r<s.rows;r++)for(let c=0;c<s.cols;c++)if(!s.board[r][c].blocked&&s.board[r][c].candy===color)set.add(key(r,c))}
async function resolve(cascade=false){let chain=cascade?s.chain:0;while(true){const ms=matches();if(!ms.length)break;chain++;const sp=specials(ms),set=new Set();for(const m of ms)for(const a of m.cells)set.add(key(a.r,a.c));const q=[...set];for(let i=0;i<q.length;i++){const [r,c]=q[i].split(",").map(Number),cell=s.board[r][c];ext(cell,r,c,set);if(cell.sp===SP.C&&cell.candy!==null)clrColor(cell.candy,set);if(set.size>q.length){const n=[...set];for(let j=q.length;j<n.length;j++)q.push(n[j])}}s.last=new Set(set);for(const k of set){const [r,c]=k.split(",").map(Number),cell=s.board[r][c];burst(r,c,cell.candy!==null?["#ff4ec9","#33d9ff","#35f49d","#ffde59","#ff8c42","#a687ff"][cell.candy]:"#fff",8);s.board[r][c]=empty();add(70,chain)}for(const [k,v] of sp.entries()){if(!set.has(k))continue;const [r,c]=k.split(",").map(Number);if(s.board[r][c].blocked)continue;s.board[r][c]={candy:v.sp===SP.C?null:v.color,sp:v.sp,blocked:false}}pop(`${msg(chain)} x${chain}`);snd(chain>1?"combo":"match");render();await wait(180);await drop()}s.chain=chain;return chain>0}
async function drop(){const c=cfg(s.level),fall={};for(let col=0;col<s.cols;col++){let w=s.rows-1;for(let r=s.rows-1;r>=0;r--){const x=s.board[r][col];if(x.blocked){w=r-1;continue}if(x.candy===null&&x.sp===null)continue;while(w>=0&&s.board[w][col].blocked)w--;if(w!==r){s.board[w][col]={candy:x.candy,sp:x.sp,blocked:false};s.board[r][col]=empty();fall[key(w,col)]=w-r}w--}for(let r=s.rows-1;r>=0;r--){if(s.board[r][col].blocked)continue;if(s.board[r][col].candy===null&&s.board[r][col].sp===null){s.board[r][col]={candy:rnd(c.colors),sp:null,blocked:false};fall[key(r,col)]=(r+1)}}}render(fall);await wait(220)}
function swap(a,b){const t=s.board[a.r][a.c];s.board[a.r][a.c]=s.board[b.r][b.c];s.board[b.r][b.c]=t}
async function animateSwap(a,b){const aEl=el.board.querySelector(`.cell[data-r="${a.r}"][data-c="${a.c}"] .candy`),bEl=el.board.querySelector(`.cell[data-r="${b.r}"][data-c="${b.c}"] .candy`);if(!aEl||!bEl)return;const wrapRect=el.wrap.getBoundingClientRect(),ar=aEl.getBoundingClientRect(),br=bEl.getBoundingClientRect();const clone=(src,rect)=>{const c=src.cloneNode(true);c.style.position="absolute";c.style.left=`${rect.left-wrapRect.left-6}px`;c.style.top=`${rect.top-wrapRect.top-6}px`;c.style.width=`${rect.width}px`;c.style.height=`${rect.height}px`;c.style.transition=`transform ${Math.max(90,Math.floor(220*s.animScale))}ms cubic-bezier(.22,1,.36,1)`;c.style.zIndex="20";return c};const ca=clone(aEl,ar),cb=clone(bEl,br),dx=br.left-ar.left,dy=br.top-ar.top;el.fx.appendChild(ca);el.fx.appendChild(cb);requestAnimationFrame(()=>{ca.style.transform=`translate(${dx}px,${dy}px)`;cb.style.transform=`translate(${-dx}px,${-dy}px)`});await wait(220);ca.remove();cb.remove()}
function hasMove(){for(let r=0;r<s.rows;r++)for(let c=0;c<s.cols;c++){if(s.board[r][c].blocked)continue;for(const [dr,dc] of [[1,0],[0,1]]){const nr=r+dr,nc=c+dc;if(!inb(nr,nc)||s.board[nr][nc].blocked)continue;swap({r,c},{r:nr,c:nc});const ok=matches().length>0;swap({r,c},{r:nr,c:nc});if(ok)return true}}return false}
async function shuffleIfStuck(){if(hasMove())return;const c=cfg(s.level),bag=[];for(let r=0;r<s.rows;r++)for(let col=0;col<s.cols;col++){const cell=s.board[r][col];if(cell.blocked)continue;bag.push({candy:cell.candy,sp:cell.sp});cell.candy=null;cell.sp=null}for(let i=bag.length-1;i>0;i--){const j=rnd(i+1);[bag[i],bag[j]]=[bag[j],bag[i]]}let idx=0;for(let r=0;r<s.rows;r++)for(let col=0;col<s.cols;col++){const cell=s.board[r][col];if(cell.blocked)continue;const item=bag[idx++]||{candy:rnd(c.colors),sp:null};cell.candy=item.candy;cell.sp=item.sp}pop("Shuffle");render();await wait(180)}
function isHintSwap(a,b){if(!s.hintPair)return false;const h=s.hintPair;return (a.r===h.a.r&&a.c===h.a.c&&b.r===h.b.r&&b.c===h.b.c)||(a.r===h.b.r&&a.c===h.b.c&&b.r===h.a.r&&b.c===h.a.c)}
function clearHint(skipRender=false){s.hintPair=null;if(skipRender)return;if(s.board.length===s.rows&&s.board[0]&&s.board[0].length===s.cols)render()}
function resetIdleHint(){if(s.idleTimer)clearTimeout(s.idleTimer);s.idleTimer=setTimeout(()=>{if(s.paused||s.busy||el.game.hidden)return;const h=findHint();if(h){s.hintPair=h;render();pop("Hint Ready")}},10000)}
function findHint(){for(let r=0;r<s.rows;r++)for(let c=0;c<s.cols;c++){if(s.board[r][c].blocked)continue;for(const [dr,dc] of [[1,0],[0,1]]){const nr=r+dr,nc=c+dc;if(!inb(nr,nc)||s.board[nr][nc].blocked)continue;swap({r,c},{r:nr,c:nc});const ok=matches().length>0;swap({r,c},{r:nr,c:nc});if(ok)return{a:{r,c},b:{r:nr,c:nc}}}}return null}
async function triggerHintBlast(a,b){const set=new Set();for(const p of [a,b])for(let rr=p.r-1;rr<=p.r+1;rr++)for(let cc=p.c-1;cc<=p.c+1;cc++)if(inb(rr,cc)&&!s.board[rr][cc].blocked)set.add(key(rr,cc));for(const k of set){const [r,c]=k.split(",").map(Number),cell=s.board[r][c];burst(r,c,cell.candy!==null?["#ff4ec9","#33d9ff","#35f49d","#ffde59","#ff8c42","#a687ff"][cell.candy]:"#fff",10);s.board[r][c]=empty();add(100,Math.max(1,s.chain+1))}s.coins+=20;pop("Hint Blast!");snd("explode");render();await wait(220);await drop();await resolve(true)}
async function applyBooster(type,r=null,c=null){if(s.busy||s.paused||!s.boosters[type]||s.boosters[type]<=0)return;resetIdleHint();if(type==="shuffle"){s.boosters.shuffle--;s.activeBooster=null;await shuffleIfStuck();snd("match");hud();save();return}if(r===null||c===null||!inb(r,c)||s.board[r][c].blocked)return;s.busy=true;let used=false;if(type==="lollipop"||type==="hammer"){if(s.board[r][c].candy!==null||s.board[r][c].sp){s.board[r][c]=empty();used=true}}if(type==="bomb"){for(let rr=r-1;rr<=r+1;rr++)for(let cc=c-1;cc<=c+1;cc++)if(inb(rr,cc)&&!s.board[rr][cc].blocked){s.board[rr][cc]=empty();used=true}}
if(used){s.boosters[type]--;s.activeBooster=null;snd("explode");render();await wait(150);await drop();await resolve(true);await turnEnd();save()}s.busy=false;hud();resetIdleHint()}
function buy(type,cost){if(s.coins<cost)return;s.coins-=cost;s.boosters[type]=(s.boosters[type]||0)+1;snd("match");hud();save()}
async function colorSwap(p,o){const other=s.board[o.r][o.c];if(other.candy===null)return false;const set=new Set([key(p.r,p.c),key(o.r,o.c)]);clrColor(other.candy,set);for(const k of set){const [r,c]=k.split(",").map(Number),cell=s.board[r][c];if(cell.blocked)continue;burst(r,c,cell.candy!==null?["#ff4ec9","#33d9ff","#35f49d","#ffde59","#ff8c42","#a687ff"][cell.candy]:"#fff",10);s.board[r][c]=empty();add(90,Math.max(1,s.chain+1))}snd("explode");pop("Color Blast");render();await wait(220);await drop();await resolve(true);return true}
async function trySwap(a,b){if(s.busy||s.paused)return;s.busy=true;resetIdleHint();const wasHint=isHintSwap(a,b);clearHint();s.selected=null;await animateSwap(a,b);const A=s.board[a.r][a.c],B=s.board[b.r][b.c];if(A.sp===SP.C||B.sp===SP.C){const used=A.sp===SP.C?await colorSwap(a,b):await colorSwap(b,a);if(used){s.moves--;hud();if(wasHint)await triggerHintBlast(a,b);await turnEnd();s.busy=false;return}}swap(a,b);snd("swap");render();await wait(80);if(!matches().length){swap(a,b);render();snd("invalid");s.busy=false;resetIdleHint();return}s.moves--;hud();await resolve(false);if(wasHint)await triggerHintBlast(a,b);await turnEnd();s.busy=false;resetIdleHint()}
async function turnEnd(){await shuffleIfStuck();hud();if(s.score>=s.target){const bonus=120+s.level*25;s.coins+=bonus;s.unlocked=Math.max(s.unlocked,s.level+1);syncLevelSelect();save();el.winTxt.textContent=`Level ${s.level} cleared. +${bonus} coins. Moves left: ${s.moves}.`;showOverlay(el.win);snd("win");return}if(s.moves<=0){el.loseTxt.textContent=`You scored ${s.score}. Target was ${s.target}.`;showOverlay(el.lose);snd("lose")}}
function tap(r,c){if(s.busy||s.paused)return;resetIdleHint();if(s.activeBooster){applyBooster(s.activeBooster,r,c);return}if(s.board[r][c].blocked)return;if(!s.selected){s.selected={r,c};render();return}if(s.selected.r===r&&s.selected.c===c){s.selected=null;render();return}const a=s.selected;s.selected=null;if(!adj(a,{r,c})){s.selected={r,c};render();return}trySwap(a,{r,c})}
function bindBoard(){el.board.addEventListener("pointerdown",e=>{if(s.paused)return;const cell=e.target.closest(".cell");if(!cell)return;s.ptr={x:e.clientX,y:e.clientY,r:+cell.dataset.r,c:+cell.dataset.c}});el.board.addEventListener("pointerup",e=>{if(!s.ptr||s.paused)return;const p=s.ptr;s.ptr=null;const dx=e.clientX-p.x,dy=e.clientY-p.y,ax=Math.abs(dx),ay=Math.abs(dy);if(Math.max(ax,ay)<14){tap(p.r,p.c);return}let tr=p.r,tc=p.c;if(ax>ay)tc+=dx>0?1:-1;else tr+=dy>0?1:-1;if(inb(tr,tc))trySwap({r:p.r,c:p.c},{r:tr,c:tc})});el.board.addEventListener("pointercancel",()=>s.ptr=null)}
function togglePause(force=null){const toPause=force===null?!s.paused:force;s.paused=toPause;if(s.paused)showOverlay(el.pause);else showOverlay(null);hud();updateBgmState()}
function msg(c){if(c>=5)return"Legend";if(c===4)return"Divine";if(c===3)return"Sweet";if(c===2)return"Tasty";return"Nice"}
function initAudio(){if(!s.sound)return;if(!ctx){const C=window.AudioContext||window.webkitAudioContext;if(!C)return;ctx=new C()}if(ctx.state==="suspended")ctx.resume()}
function tone(f,d=.06,w="triangle",v=.05,delay=0){if(!ctx||!s.sound)return;const o=ctx.createOscillator(),g=ctx.createGain(),t=ctx.currentTime+delay,vol=Math.max(.0001,v*s.volume);o.type=w;o.frequency.value=f;o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(vol,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+d);o.start(t);o.stop(t+d+.01)}
function snd(t){if(!s.sound)return;initAudio();if(!ctx)return;if(t==="swap")tone(360,.05,"triangle",.04);if(t==="invalid"){tone(220,.07,"sawtooth",.03);tone(180,.08,"sawtooth",.03,.05)}if(t==="match"){tone(450,.05,"triangle",.05);tone(560,.05,"triangle",.05,.05)}if(t==="combo"){tone(460,.05,"triangle",.05);tone(620,.05,"triangle",.05,.05);tone(760,.06,"triangle",.05,.1)}if(t==="explode"){tone(190,.08,"square",.06);tone(120,.09,"square",.05,.05)}if(t==="win"){tone(520,.06,"triangle",.06);tone(700,.06,"triangle",.06,.07);tone(920,.08,"triangle",.06,.14)}if(t==="lose"){tone(300,.08,"sawtooth",.04);tone(220,.09,"sawtooth",.04,.08)}}
function shouldPlayBgm(){return s.sound&&!s.paused&&!el.game.hidden&&!el.win.classList.contains("show")&&!el.lose.classList.contains("show")&&!el.help.classList.contains("show")&&!el.settings.classList.contains("show")&&!el.home.classList.contains("show")}
function startBgm(){if(bgmTimer||!shouldPlayBgm())return;initAudio();if(!ctx)return;const seq=[261.63,329.63,392,523.25,392,329.63,293.66,349.23];bgmTimer=setInterval(()=>{const n=seq[bgmStep%seq.length];bgmStep++;tone(n,.23,"sine",.018)},420)}
function stopBgm(){if(bgmTimer){clearInterval(bgmTimer);bgmTimer=null}}
function updateBgmState(){if(shouldPlayBgm())startBgm();else stopBgm()}
function bg(){el.bg.innerHTML="";const n=innerWidth<700?28:50;for(let i=0;i<n;i++){const p=document.createElement("span");p.className="dust";p.style.left=`${Math.random()*100}%`;p.style.top=`${80+Math.random()*40}%`;const z=2+Math.random()*5;p.style.width=`${z}px`;p.style.height=`${z}px`;p.style.animationDuration=`${7+Math.random()*9}s`;p.style.animationDelay=`${Math.random()*5}s`;el.bg.appendChild(p)}}
function start(level){s.level=Math.max(1,Math.min(level,s.unlocked));s.score=0;s.paused=false;s.activeBooster=null;clearHint(true);el.game.hidden=false;requestAnimationFrame(()=>el.game.classList.remove("hidden-state"));showOverlay(null);mkBoard();snd("swap");updateBgmState();resetIdleHint()}
function retry(){showOverlay(null);s.paused=false;s.activeBooster=null;clearHint(true);mkBoard();hud();updateBgmState();resetIdleHint()}
function bind(){bindBoard();el.levelSelect.addEventListener("change",()=>{s.startLevel=Math.max(1,Math.min(s.unlocked,Number(el.levelSelect.value)||1));hud()});el.themeSelect.addEventListener("change",()=>{s.theme=el.themeSelect.value;save()});el.startBtn.addEventListener("click",()=>{initAudio();start(s.startLevel)});el.soundBtn.addEventListener("click",()=>{s.sound=!s.sound;if(s.sound)initAudio();hud();save();updateBgmState()});el.helpHomeBtn.addEventListener("click",()=>{s.overlayReturn=el.home;showOverlay(el.help)});el.helpGameBtn.addEventListener("click",()=>{s.overlayReturn=s.paused?el.pause:null;showOverlay(el.help)});el.closeHelpBtn.addEventListener("click",()=>{showOverlay(s.overlayReturn);s.overlayReturn=null;hud();updateBgmState()});el.settingsHomeBtn.addEventListener("click",()=>{s.overlayReturn=el.home;syncSettingsUi();showOverlay(el.settings)});el.settingsGameBtn.addEventListener("click",()=>{s.overlayReturn=s.paused?el.pause:null;syncSettingsUi();showOverlay(el.settings)});el.closeSettingsBtn.addEventListener("click",()=>{showOverlay(s.overlayReturn);s.overlayReturn=null;hud();updateBgmState()});el.speedRange.addEventListener("input",()=>{s.animScale=(Number(el.speedRange.value)||100)/100;el.speedVal.textContent=`${Math.round(s.animScale*100)}%`;save()});el.volumeRange.addEventListener("input",()=>{s.volume=(Number(el.volumeRange.value)||100)/100;el.volumeVal.textContent=`${Math.round(s.volume*100)}%`;save();updateBgmState()});
[el.boosterLollipop,el.boosterHammer,el.boosterBomb,el.boosterShuffle].forEach(btn=>btn.addEventListener("click",()=>{const t=btn.dataset.booster;if(!s.boosters[t]||s.boosters[t]<=0)return;if(t==="shuffle"){applyBooster("shuffle");return}s.activeBooster=s.activeBooster===t?null:t;s.selected=null;render();hud()}));
el.buyLollipop.addEventListener("click",()=>buy("lollipop",120));el.buyHammer.addEventListener("click",()=>buy("hammer",150));el.buyBomb.addEventListener("click",()=>buy("bomb",240));el.buyShuffle.addEventListener("click",()=>buy("shuffle",200));
el.pauseBtn.addEventListener("click",()=>{if(el.game.hidden)return;togglePause()});el.restartLevelBtn.addEventListener("click",()=>{if(el.game.hidden)return;retry()});el.resumeBtn.addEventListener("click",()=>togglePause(false));el.pauseRestartBtn.addEventListener("click",()=>retry());el.nextBtn.addEventListener("click",()=>{showOverlay(null);s.level++;start(s.level)});el.retryBtn.addEventListener("click",()=>retry());el.retryWinBtn.addEventListener("click",()=>retry());el.homeBtn.addEventListener("click",()=>{showOverlay(el.home);s.paused=false;clearHint(true);el.game.classList.add("hidden-state");setTimeout(()=>{el.game.hidden=true;updateBgmState()},220);hud()});
document.addEventListener("keydown",e=>{if(e.key===" "){e.preventDefault();if(!el.game.hidden)togglePause()}if((e.key==="r"||e.key==="R")&&!el.game.hidden)retry();if(e.key==="m"||e.key==="M"){s.sound=!s.sound;if(s.sound)initAudio();hud();save();updateBgmState()}if((e.key==="h"||e.key==="H")&&!el.help.classList.contains("show")){s.overlayReturn=el.game.hidden?el.home:(s.paused?el.pause:null);showOverlay(el.help)}if((e.key==="s"||e.key==="S")&&!el.settings.classList.contains("show")){s.overlayReturn=el.game.hidden?el.home:(s.paused?el.pause:null);syncSettingsUi();showOverlay(el.settings)}})}
async function init(){load();s.startLevel=s.unlocked;syncLevelSelect();syncSettingsUi();bg();bind();hud();showOverlay(el.loading);await wait(850);showOverlay(el.home);updateBgmState();addEventListener("resize",bg,{passive:true})}
init();
</script>
</body>
</html>
